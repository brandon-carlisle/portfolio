---
// Use env if set (e.g. .dev.vars / Cloudflare env); otherwise use Cloudflare's test key for local preview.
import { PUBLIC_CF_SITE_KEY } from "astro:env/client";
---

<footer class="py-16">
  <div class="mb-10">
    <h2 class="text-3xl font-semibold mb-3 text-neutral-100">Get in Touch</h2>
    <p class="text-neutral-400 text-lg">
      Have a question or a project in mind? Drop me a message.
    </p>
  </div>

  <form id="contact-form" class="space-y-5 mb-12">
    <div>
      <label for="name" class="block text-sm font-medium text-neutral-400 mb-2"
        >Your Name</label
      >
      <input
        id="name"
        type="text"
        name="name"
        placeholder="Steve Jobs"
        required
        minlength="2"
        class="w-full px-4 py-3 bg-neutral-900/50 text-neutral-100 placeholder:text-neutral-600 border border-neutral-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500/50 transition-all duration-300"
      />
    </div>

    <div>
      <label for="email" class="block text-sm font-medium text-neutral-400 mb-2"
        >Your Email</label
      >
      <input
        id="email"
        type="email"
        name="email"
        placeholder="sjobs@apple.com"
        required
        class="w-full px-4 py-3 bg-neutral-900/50 text-neutral-100 placeholder:text-neutral-600 border border-neutral-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500/50 transition-all duration-300"
      />
    </div>

    <div>
      <label
        for="message"
        class="block text-sm font-medium text-neutral-400 mb-2">Message</label
      >
      <textarea
        id="message"
        name="message"
        rows="5"
        placeholder="Let's work together!"
        required
        class="w-full px-4 py-3 bg-neutral-900/50 text-neutral-100 placeholder:text-neutral-600 border border-neutral-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:border-emerald-500/50 transition-all duration-300 resize-none"
      ></textarea>
    </div>

    <div
      id="cf-turnstile"
      class="min-h-[65px]"
      data-site-key={PUBLIC_CF_SITE_KEY}
    >
    </div>
    <input
      type="hidden"
      name="cf-turnstile-response"
      id="cf-turnstile-response"
      value=""
    />

    <div
      id="form-status"
      class="hidden rounded-lg px-4 py-3 text-sm font-medium"
    >
    </div>

    <button
      type="submit"
      class="group px-6 py-3 bg-emerald-500 hover:bg-emerald-600 transition-all duration-300 rounded-lg font-medium text-white hover:shadow-lg hover:shadow-emerald-500/20 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id="btn-text">Send Message</span>
      <span
        id="btn-arrow"
        class="group-hover:translate-x-1 transition-transform duration-300"
        >&rarr;</span
      >
      <svg
        id="btn-spinner"
        class="hidden animate-spin h-5 w-5"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
    </button>
  </form>

  <div
    class="pt-8 border-t border-neutral-800/50 flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-neutral-500"
  >
    <p>
      &copy; {new Date().getFullYear()} Brandon Carlisle. All rights reserved.
    </p>
    <div class="flex gap-6">
      <a href="/" class="hover:text-emerald-400 transition-colors duration-300"
        >Home</a
      >
      <a
        href="/about"
        class="hover:text-emerald-400 transition-colors duration-300">About</a
      >
      <a
        href="/projects"
        class="hover:text-emerald-400 transition-colors duration-300"
        >Projects</a
      >
    </div>
  </div>
</footer>

<script
  is:inline
  src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit"
  async
  defer></script>

<script is:inline>
  // Render Turnstile widget once the API and site key are ready
  var cfWidgetId = null;
  var renderWidget = function () {
    if (typeof turnstile === "undefined") return false;
    var container = document.getElementById("cf-turnstile");
    if (!container || container.hasAttribute("data-rendered")) return false;
    var siteKey = container.getAttribute("data-site-key");
    if (!siteKey) return false;
    try {
      cfWidgetId = turnstile.render("#cf-turnstile", {
        sitekey: siteKey,
        theme: "dark",
        callback: function (token) {
          var input = document.getElementById("cf-turnstile-response");
          if (input) input.value = token;
        },
      });
      container.setAttribute("data-rendered", "true");
      window.cfWidgetId = cfWidgetId;
      return true;
    } catch (error) {
      console.error("Turnstile render failed:", error);
      return false;
    }
  };

  var renderAttempts = 0;
  var maxRenderAttempts = 50; // 5s total
  function tryRender() {
    var rendered = renderWidget();
    var container = document.getElementById("cf-turnstile");
    var hasSiteKey = !!(container && container.getAttribute("data-site-key"));
    if (!rendered && hasSiteKey && renderAttempts < maxRenderAttempts) {
      renderAttempts += 1;
      setTimeout(tryRender, 100);
    }
  }

  if (document.readyState === "complete") {
    tryRender();
  } else {
    window.addEventListener("load", function () {
      tryRender();
    });
  }
</script>

<script>
  import { actions, isInputError } from "astro:actions";

  const form = document.getElementById("contact-form") as HTMLFormElement;
  const status = document.getElementById("form-status") as HTMLElement;
  const btnText = document.getElementById("btn-text") as HTMLElement;
  const btnArrow = document.getElementById("btn-arrow") as HTMLElement;
  const btnSpinner = document.getElementById("btn-spinner") as HTMLElement;
  const submitBtn = form.querySelector(
    'button[type="submit"]',
  ) as HTMLButtonElement;

  function showStatus(message: string, type: "success" | "error") {
    status.textContent = message;
    status.classList.remove(
      "hidden",
      "bg-emerald-500/10",
      "text-emerald-400",
      "border-emerald-500/20",
      "bg-red-500/10",
      "text-red-400",
      "border-red-500/20",
    );

    if (type === "success") {
      status.classList.add(
        "bg-emerald-500/10",
        "text-emerald-400",
        "border",
        "border-emerald-500/20",
      );
    } else {
      status.classList.add(
        "bg-red-500/10",
        "text-red-400",
        "border",
        "border-red-500/20",
      );
    }
  }

  function setLoading(loading: boolean) {
    submitBtn.disabled = loading;
    btnText.textContent = loading ? "Sending..." : "Send Message";
    btnArrow.classList.toggle("hidden", loading);
    btnSpinner.classList.toggle("hidden", !loading);
  }

  function clearTurnstileToken() {
    const tokenInput = document.getElementById(
      "cf-turnstile-response",
    ) as HTMLInputElement | null;
    if (tokenInput) tokenInput.value = "";
  }

  function resetTurnstileWidget() {
    if (typeof turnstile !== "undefined" && window.cfWidgetId != null) {
      turnstile.reset(window.cfWidgetId);
      clearTurnstileToken();
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    status.classList.add("hidden");
    setLoading(true);

    const formData = new FormData(form);
    const { error } = await actions.contact(formData);

    setLoading(false);

    if (error) {
      if (isInputError(error)) {
        const messages = Object.values(error.fields).flat().join(" ");
        showStatus(messages || "Please check your input.", "error");
      } else {
        showStatus(
          error.message || "Something went wrong. Please try again.",
          "error",
        );
      }

      // Reset the Turnstile widget so the user can retry
      resetTurnstileWidget();
      return;
    }

    showStatus("Message sent! I'll get back to you soon.", "success");
    form.reset();

    // Reset the Turnstile widget after successful submission
    resetTurnstileWidget();
  });
</script>
